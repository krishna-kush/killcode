# Production Docker Compose Configuration
# Loads variables from .env.production file
# Usage: docker compose -f docker-compose.prod.yml --env-file .env.production up -d

services:
  # MongoDB Keyfile Initializer (runs once to create keyfile)
  mongodb-init:
    image: alpine/openssl
    container_name: killcode-mongodb-init
    entrypoint: ["/bin/sh"]
    volumes:
      - ./secrets:/secrets
      - ./scripts/init-mongodb-keyfile.sh:/init-mongodb-keyfile.sh:ro
    command: ["/init-mongodb-keyfile.sh"]
    restart: "no"
  
  # MongoDB Replica Set Configurator
  mongodb-configurator:
    image: mongo:8.2.1
    container_name: killcode-mongodb-configurator
    restart: "no"
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./scripts/init-replica-set.sh:/init-replica-set.sh:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    command: ["/init-replica-set.sh"]
    networks:
      - killcode-network

  # MongoDB Database
  mongodb:
    image: mongo:8.2.1
    container_name: killcode-mongodb-prod
    restart: always
    command: ["--replSet", "rs0", "--bind_ip_all", "--keyFile", "/data/mongodb-keyfile"]
    user: "999:999"
    ports:
      - "${MONGODB_PORT}:27017"
    volumes:
      - mongodb_data:/data/db
      - ./scripts/mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh:ro
      - ./secrets/mongodb-keyfile:/data/mongodb-keyfile:ro
    networks:
      - killcode-network
    depends_on:
      mongodb-init:
        condition: service_completed_successfully
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: killcode

  # Redis for Progress Tracking
  redis:
    image: redis:7-alpine
    container_name: killcode-redis-prod
    restart: always
    ports:
      - "${REDIS_PORT}:6379"
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - killcode-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Rust Backend Server
  server:
    build:
      context: ./server
      dockerfile: Dockerfile.prod
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: killcode-server:latest
    container_name: killcode-server-prod
    restart: always
    ports:
      - "${SERVER_PORT_EXTERNAL}:8080"
    env_file:
      - .env.production
    depends_on:
      mongodb:
        condition: service_healthy
      mongodb-configurator:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      weaver:
        condition: service_healthy
    networks:
      - killcode-network
    volumes:
      - ./killer/builds:/app/overload_bins:ro
      - ./server/geoip/data:/server/geoip/data:ro
      - server_uploads:/app/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Binary Weaving Service
  weaver:
    platform: linux/amd64
    build:
      context: ./weaver
      dockerfile: Dockerfile.prod
      additional_contexts:
        osxcross: ./osxcross/target
        llvm-mingw: ./llvm-mingw/llvm-mingw-ucrt
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: killcode-weaver:latest
    container_name: killcode-weaver-prod
    restart: always
    ports:
      - "${WEAVER_PORT_EXTERNAL}:8080"
    env_file:
      - .env.production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - killcode-network
    volumes:
      - weaver_temp:/tmp/weaver
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Next.js UI
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile.prod
      args:
        BUILDKIT_INLINE_CACHE: 1
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    image: killcode-ui:latest
    container_name: killcode-ui-prod
    restart: always
    ports:
      - "${UI_PORT}:3000"
    env_file:
      - .env.production
    depends_on:
      server:
        condition: service_healthy
    networks:
      - killcode-network

networks:
  killcode-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local
  server_uploads:
    driver: local
  weaver_temp:
    driver: local
